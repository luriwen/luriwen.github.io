---
layout: post
title: I2C 协议
date: 2015-11-11 20:26:38 +0800
category: 内核驱动

---

## 一、I2C概述
I2C总线是一种两线式串行总线，用于连接微控制器与外围总线。

## 二、I2C总线特点
I2C总线最主要优点是其简单性和有效性。由于接口直接在总线上，因此I2C总线占用的空间小，减少了电路板的空间和芯片管脚的数量，降低了互联成本。I2C总线的另一个优点是支持多主控，其中任何能够进行发送和接收的设备都可以成为主总线。一个主控能控制信号的传输和时钟频率，在任何时间点上只能有一个主控。

## 三、总线的构成及信号类型
I2C总线是由数据线SDA和时钟线SCL构成的串行总线，可以发送和接收数据。每个接到I2C总线上的器件都有唯一的地址。主机与其他器件间的数据传送可以是由主机发送数据给器件，这时主机即为发送器，由总线上接收数据的器件则为接收器。
I2C总线通过上拉电阻接正电源。当总线空闲时，两根线均为高电平。连接到总线上的任意器件输出为低电平，都将使总线的信号变低，即各器件的SDA及SCL都是线与关系。
![i2c-1]({{site.baseurl}}/assets/img/driver/20180315-i2c.img/i2c-1.png)

  I2C总线在传送数据过程中共有三种信号类型，分别是：开始信号、结束信号和应答信号。

开始信号：SCL为高电平时，SDA由高电平向低电平跳变，开始数据传送。开始信号是一种电平跳变时序信号，而不是一个电平信号；

终止信号：SCL为高电平时，SDA由低电平向高电平跳变，结束数据传送。结束信号也是一种电平跳变时序信号，而不是一个电平信号；

应答信号：I2C总线上的数据都是以8位字节传送的，发送器每发送一个字节，就在时序脉冲9期间释放数据线，由接收器反馈一个应答信号。应答信号为低电平时，规定为有效应答位(ACK)，表示接收器已经成功的接收了该字节；应答信号为高电平时，规定为非应答位(NACK)，一般表示接收器接收该字节没有成功。

![i2c-2]({{site.baseurl}}/assets/img/driver/20180315-i2c.img/i2c-2.png)

![i2c-3]({{site.baseurl}}/assets/img/driver/20180315-i2c.img/i2c-3.png)

## 四、数据传送
在I2C总线上传送的每一位数据都有一个时序脉冲相对应，即在SCL串行时钟的配合下，在SDA上串行的传送每一位数据。数据位的传输是边沿触发。
I2C协议中很重要的一点是I2C地址。协议中地址有7位和10位两种形式。实际使用中一般使用7位地址。

I2C协议中数据传输时序图如下：
![i2c-4]({{site.baseurl}}/assets/img/driver/20180315-i2c.img/i2c-4.png)

SCL是时钟，SDA承载的是数据。当SDA从1变到0，而SCL还是为1时，表示开始传输数据。接下来的7位ADDRESS就是设备的地址。紧接着第8位为读写标志，为1时表示读，为0时表示写。如果I2C总线上存在着和请求的地址相对应的设备，则从设备会发送一个ACK信号通知主设备，可以发送数据了。接到ACK信号后，主设备发送一个8位的数据。当传输完毕之后，SCL保持为1，SDA从0变到1时，表示传输结束。

### 4.1 数据的有效性
I2C总线进行数据传送时，时钟信号为高电平期间，数据线上的数据必须保持稳定，只有在时钟线上的信号为低电平期间，数据线上的高电平或低电平状态才允许变化。
![i2c-5]({{site.baseurl}}/assets/img/driver/20180315-i2c.img/i2c-5.png)

### 4.2 字节格式
发送到SDA线上的每个字节必须为8位。每次传输可以发送的字节数量不受限制。每个字节后必须跟一个响应位。

## 五、工作过程
总线上的所有通信都是由主控制器引发的。在一次通信中，主控制器与被控制器总是在扮演着两种不同的角色。

### 5.1 主设备向从设备发送数据
主设备发送起始位，这会通知总线上的所有设备传输开始了，接下来主机发送设备地址，与这一地址匹配的从设备将继续这一传输过程，而其他从设备将会忽略接下来的传输并等待下一次传输的开始。主设备寻址到从设备后，发送他所要读或写的从设备的内部寄存器地址。之后，发送数据。数据发送完毕后，发送停止位，结束传输。

写入过程如下：

 - 发送起始位；
 - 发送从设备的地址和读/写选择位。释放总线，等待从设备拉低总线进行应答。如果从设备接收成功，则进行应答。否则不产生应答，要求重发或终止发送；
 - 发送要写入的从设备的内部寄存器地址。从设备进行应答；
 - 发送数据；
 - 发送停止位。


写操作时，数据传输方向如下图所示：
![i2c-6]({{site.baseurl}}/assets/img/driver/20180315-i2c.img/i2c-6.png)

写时序的流程：

 - START --->
 - 从设备的地址 ---> ACK --->
 - 从设备的寄存器地址 ---> ACK --->
 - 写入的数据 --->
 - STOP


### 5.2 主设备从从设备读数据
相对写过程，读的过程比较复杂，在从设备读出数据前，需要告诉从设备想要读哪个内部寄存器，因为必须先对其进行写入(dummy write)。

读取过程如下：

 - 发送起始位；
 - 发送从设备地址和读/写选择位；
 - 发送内部寄存器地址；
 - 重新发送起始位；
 - 重新发送从设备地址和读/写选择位；
 - 读数据。主机接收器在接收到最后一个字节后，也不会发出ACK信号。于是，从机发送器释放SDA线，以允许主机发出结束信号结束传输；
 - 发送停止位。

读操作时，数据传输方向如下图所示：
![i2c-7]({{site.baseurl}}/assets/img/driver/20180315-i2c.img/i2c-7.png)

读时序的流程：

 - START --->
 - 从设备的写地址 ---> ACK --->
 - 从设备的寄存器地址 ---> ACK --->
 - 从设备的读地址 ---> ACK --->
 - 读出的数据 --->
 - STOP

### 5.3 示例
![i2c-8]({{site.baseurl}}/assets/img/driver/20180315-i2c.img/i2c-8.gif)

从图中可知时序如下：

 1. 由主机发起，在SCL为高电平时，SDA由高到低切变，形成开始信号；
 2. 接着是7位地址和1位读写标志，这里7位地址为0111100，第8位为0表示写操作；
 3. 接着在下一个时钟，主机以高电平状态释放SDA，这时从机响应，将SDA拉低；
  4. 传送8位数据。


